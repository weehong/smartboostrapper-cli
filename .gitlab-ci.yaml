stages:
  - build
  - test
  - analysis
  - quality-gate
  - publish

variables:
  MAVEN_OPTS: >-
    -Dhttps.protocols=TLSv1.2
    -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true
  MAVEN_CLI_OPTS: >-
    --batch-mode
    --errors
    --fail-at-end
    --show-version
    --no-transfer-progress
  SONAR_HOST_URL: "https://sonarcloud.io"
  SONAR_PROJECT_KEY: "upmatches"
  SONAR_ORGANIZATION: "weehong"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository
    - target/

#-------------------------------------------------------------------------------
#                              Build Stage
#-------------------------------------------------------------------------------

build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  before_script:
    - |
      mkdir -p ~/.m2
      cat > ~/.m2/settings.xml << EOF
      <settings>
        <servers>
          <server>
            <id>github</id>
            <username>${GITHUB_USERNAME}</username>
            <password>${GITHUB_TOKEN}</password>
          </server>
        </servers>
      </settings>
      EOF
  script:
    - mvn $MAVEN_CLI_OPTS compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "main"

#-------------------------------------------------------------------------------
#                               Test Stage
#-------------------------------------------------------------------------------

test:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  needs:
    - build
  before_script:
    - |
      mkdir -p ~/.m2
      cat > ~/.m2/settings.xml << EOF
      <settings>
        <servers>
          <server>
            <id>github</id>
            <username>${GITHUB_USERNAME}</username>
            <password>${GITHUB_TOKEN}</password>
          </server>
        </servers>
      </settings>
      EOF
  script:
    - mvn $MAVEN_CLI_OPTS verify
  artifacts:
    paths:
      - target/classes/
      - target/test-classes/
      - target/site/jacoco/
      - target/surefire-reports/
      - .qodana/code-coverage/
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    expire_in: 1 week
  coverage: '/Total.*?([0-9]{1,3})%/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "main"

#-------------------------------------------------------------------------------
#                          SonarCloud Analysis Stage
#-------------------------------------------------------------------------------

sonarcloud-analysis:
  stage: analysis
  image: sonarsource/sonar-scanner-cli:latest
  needs:
    - job: build
      artifacts: true
    - job: test
      artifacts: true
  variables:
    GIT_DEPTH: "0"
  script:
    - |
      if [ "$CI_PIPELINE_SOURCE" == "merge_request_event" ]; then
        sonar-scanner \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.organization=${SONAR_ORGANIZATION} \
          -Dsonar.host.url=${SONAR_HOST_URL} \
          -Dsonar.token=${SONAR_TOKEN} \
          -Dsonar.sources=src/main/java \
          -Dsonar.tests=src/test/java \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.java.test.binaries=target/test-classes \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
          -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} \
          -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} \
          -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}
      else
        sonar-scanner \
          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
          -Dsonar.organization=${SONAR_ORGANIZATION} \
          -Dsonar.host.url=${SONAR_HOST_URL} \
          -Dsonar.token=${SONAR_TOKEN} \
          -Dsonar.sources=src/main/java \
          -Dsonar.tests=src/test/java \
          -Dsonar.java.binaries=target/classes \
          -Dsonar.java.test.binaries=target/test-classes \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
          -Dsonar.branch.name=${CI_COMMIT_REF_NAME}
      fi
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "main"

#-------------------------------------------------------------------------------
#                           Qodana Code Analysis
#-------------------------------------------------------------------------------

include:
  - component: $CI_SERVER_FQDN/qodana/qodana/qodana-gitlab-ci@v2025.2
    inputs:
      mr-mode: false
      use-caches: true
      post-mr-comment: true
      upload-result: true
      push-fixes: 'none'
      args: --coverage-dir,$CI_PROJECT_DIR/.qodana/code-coverage,--image,jetbrains/qodana-jvm:2025.2,--env,GITHUB_USERNAME=${GITHUB_USERNAME},--env,GITHUB_TOKEN=${GITHUB_TOKEN}

qodana:
  stage: analysis
  needs:
    - test
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "dev"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"

#-------------------------------------------------------------------------------
#                         Quality Gate Check Stage
#-------------------------------------------------------------------------------

quality-gate-check:
  stage: quality-gate
  image: alpine:latest
  needs:
    - sonarcloud-analysis
    - qodana
    - job: test
      artifacts: true
  variables:
    GIT_STRATEGY: none
    COVERAGE_THRESHOLD: "80"
  before_script:
    - apk add --no-cache curl libxml2-utils jq
  script:
    - |
      echo "=============================================="
      echo "       Quality Gate & Coverage Check          "
      echo "=============================================="

      # SonarCloud Quality Gate Check (with retry for analysis processing)
      echo ""
      echo "[1/3] Checking SonarCloud Quality Gate..."
      echo "      Waiting for analysis report to be processed..."

      MAX_RETRIES=30
      RETRY_INTERVAL=10
      RETRY_COUNT=0
      QUALITY_GATE_STATUS=""

      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        RESPONSE=$(curl -s -H "Authorization: Bearer ${SONAR_TOKEN}" \
          "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}")
        QUALITY_GATE_STATUS=$(echo "$RESPONSE" | jq -r '.projectStatus.status // empty')

        if [ -n "$QUALITY_GATE_STATUS" ] && [ "$QUALITY_GATE_STATUS" != "null" ]; then
          break
        fi

        RETRY_COUNT=$((RETRY_COUNT + 1))
        echo "      Analysis not ready yet, retrying in ${RETRY_INTERVAL}s... (${RETRY_COUNT}/${MAX_RETRIES})"
        sleep $RETRY_INTERVAL
      done

      if [ -z "$QUALITY_GATE_STATUS" ] || [ "$QUALITY_GATE_STATUS" = "null" ]; then
        echo "      [FAILED] Could not retrieve Quality Gate status after ${MAX_RETRIES} retries"
        exit 1
      fi

      echo "      SonarCloud Quality Gate Status: $QUALITY_GATE_STATUS"

      if [ "$QUALITY_GATE_STATUS" != "OK" ]; then
        echo "      [FAILED] SonarCloud Quality Gate did not pass!"
        exit 1
      fi
      echo "      [PASSED] SonarCloud Quality Gate"

      # SonarCloud Coverage Check
      echo ""
      echo "[2/3] Checking SonarCloud Coverage (minimum ${COVERAGE_THRESHOLD}%)..."

      # Fetch both coverage and lines of code metrics
      SONAR_METRICS=$(curl -s -H "Authorization: Bearer ${SONAR_TOKEN}" \
        "${SONAR_HOST_URL}/api/measures/component?component=${SONAR_PROJECT_KEY}&metricKeys=coverage,ncloc")

      SONAR_COVERAGE=$(echo "$SONAR_METRICS" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // empty' 2>/dev/null)
      SONAR_NCLOC=$(echo "$SONAR_METRICS" | jq -r '.component.measures[] | select(.metric=="ncloc") | .value // empty' 2>/dev/null)

      if [ -z "$SONAR_NCLOC" ] || [ "$SONAR_NCLOC" = "0" ]; then
        echo "      [SKIPPED] No lines of code to analyze - no source code to cover"
        SONAR_COVERAGE="N/A"
      elif [ -z "$SONAR_COVERAGE" ]; then
        echo "      [SKIPPED] Could not retrieve SonarCloud coverage"
        SONAR_COVERAGE="N/A"
      else
        echo "      SonarCloud Coverage: ${SONAR_COVERAGE}%"
        SONAR_COVERAGE_INT=$(echo "$SONAR_COVERAGE" | cut -d'.' -f1)
        if [ "$SONAR_COVERAGE_INT" -lt "$COVERAGE_THRESHOLD" ]; then
          echo "      [FAILED] SonarCloud coverage ${SONAR_COVERAGE}% is below ${COVERAGE_THRESHOLD}% threshold!"
          exit 1
        fi
        echo "      [PASSED] SonarCloud Coverage"
      fi

      # JaCoCo Coverage Check
      echo ""
      echo "[3/3] Checking JaCoCo Coverage Report (minimum ${COVERAGE_THRESHOLD}%)..."
      JACOCO_REPORT="target/site/jacoco/jacoco.xml"

      if [ ! -f "$JACOCO_REPORT" ]; then
        echo "      [SKIPPED] JaCoCo report not found - no source code to cover"
        JACOCO_COVERAGE="N/A"
      else
        MISSED=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@missed)" "$JACOCO_REPORT" 2>/dev/null || echo "")
        COVERED=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@covered)" "$JACOCO_REPORT" 2>/dev/null || echo "")

        if [ -z "$MISSED" ] && [ -z "$COVERED" ]; then
          echo "      [SKIPPED] No class files to analyze - no source code to cover"
          JACOCO_COVERAGE="N/A"
        else
          MISSED=${MISSED:-0}
          COVERED=${COVERED:-0}
          TOTAL=$((MISSED + COVERED))

          if [ "$TOTAL" -eq 0 ]; then
            echo "      [SKIPPED] No instructions to cover - no source code to cover"
            JACOCO_COVERAGE="N/A"
          else
            JACOCO_COVERAGE=$((COVERED * 100 / TOTAL))
            echo "      JaCoCo Instruction Coverage: ${JACOCO_COVERAGE}% (${COVERED}/${TOTAL})"

            if [ "$JACOCO_COVERAGE" -lt "$COVERAGE_THRESHOLD" ]; then
              echo "      [FAILED] JaCoCo coverage ${JACOCO_COVERAGE}% is below ${COVERAGE_THRESHOLD}% threshold!"
              exit 1
            fi
            echo "      [PASSED] JaCoCo Coverage"
          fi
        fi
      fi

      # Summary
      echo ""
      echo "=============================================="
      echo "       All Quality Gates Passed!              "
      echo "=============================================="
      echo "  - SonarCloud Quality Gate: $QUALITY_GATE_STATUS"
      echo "  - SonarCloud Coverage: ${SONAR_COVERAGE}%"
      echo "  - JaCoCo Coverage: ${JACOCO_COVERAGE}%"
      echo "  - Minimum Threshold: ${COVERAGE_THRESHOLD}%"
      echo "=============================================="
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "main"

#-------------------------------------------------------------------------------
#                         Docker Hub Publish Stage
#-------------------------------------------------------------------------------

docker-publish:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  needs:
    - quality-gate-check
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    IMAGE_NAME: ${CI_PROJECT_NAME}
  before_script:
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="${CI_COMMIT_TAG#v}"
        LATEST_TAG="latest"
      elif [ "$CI_COMMIT_BRANCH" == "main" ]; then
        VERSION="rc-${CI_PIPELINE_IID}"
        LATEST_TAG="rc-latest"
      elif [ "$CI_COMMIT_BRANCH" == "dev" ]; then
        VERSION="dev-${CI_PIPELINE_IID}"
        LATEST_TAG="dev-latest"
      else
        echo "No matching branch or tag for publishing"
        exit 1
      fi

      docker build \
        --file deployments/Dockerfile \
        --tag "$DOCKERHUB_USERNAME/$IMAGE_NAME:$VERSION" \
        --tag "$DOCKERHUB_USERNAME/$IMAGE_NAME:$LATEST_TAG" \
        .
      docker push "$DOCKERHUB_USERNAME/$IMAGE_NAME:$VERSION"
      docker push "$DOCKERHUB_USERNAME/$IMAGE_NAME:$LATEST_TAG"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == "dev"
    - if: $CI_COMMIT_BRANCH == "main"